<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>FE2CM Audio Player</title>
  <style>
    :root {
      --bg-color: #1a202c;
      --card-bg: #2d3748;
      --accent: #3182ce;
      --danger: #e53e3e;
      --text-main: #edf2f7;
      --text-muted: #a0aec0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: transparent;
      user-select: none;
      height: 100vh;
      overflow: hidden;
    }

    #app-container {
      background-color: var(--bg-color);
      color: var(--text-main);
      height: 87.5%;
      border-radius: 10px;
      border: 1px solid #4a5568;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
    }

    /* TITLE BAR */
    #title-bar {
      height: 32px;
      background: #2d3748;
      display: flex;
      align-items: center;
      padding: 0 10px;
      border-radius: 10px 10px 0 0;
      -webkit-app-region: drag;
    }

    .title-text {
      font-size: 12px;
      color: var(--text-muted);
      flex-grow: 1;
      text-align: center;
      pointer-events: none;
    }

    .window-controls {
      display: flex;
      gap: 8px;
      -webkit-app-region: no-drag;
    }

    .control-btn {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      cursor: pointer;
      border: none;
    }

    .btn-close { background-color: #ff5f56; }
    .btn-close:hover { background-color: #bf403a; }
    .btn-min { background-color: #ffbd2e; }
    .btn-min:hover { background-color: #c99624; }

    /* CONTENT */
    #content { padding: 20px; flex-grow: 1; }

    /* LOGIN SCREEN */
    #login-screen {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 50px;
      text-align: center;
    }

    input[type="text"] {
      background: var(--card-bg);
      border: 1px solid #4a5568;
      color: white;
      padding: 12px;
      border-radius: 6px;
      font-size: 16px;
      outline: none;
      text-align: center;
    }
    input[type="text"]:focus { border-color: var(--accent); }

    button {
      border: none;
      padding: 12px;
      border-radius: 6px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
      width: 100%;
    }

    .connect-btn { background: var(--accent); color: white; }
    .connect-btn:hover { background: #2b6cb0; }
    .disconnect-btn { background: var(--danger); color: white; margin-top: 20px; }
    .disconnect-btn:hover { background: #c53030; }

    /* DASHBOARD */
    #dashboard {
      display: none;
      background: var(--card-bg);
      padding: 20px;
      border-radius: 8px;
    }

    .status-bar { margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #4a5568; text-align: center; }
    .status-user { color: var(--accent); font-weight: bold; }

    /* CONTROLS */
    .control-group { margin-bottom: 20px; }
    .label-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: 600; font-size: 14px;}
    
    input[type=range] { -webkit-appearance: none; appearance: none; width: 100%; background: transparent; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: var(--accent); cursor: pointer; margin-top: -6px; }
    input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #4a5568; border-radius: 2px; }

    .radio-group { display: flex; flex-direction: column; gap: 8px; font-size: 14px; }
    .radio-option { display: flex; align-items: center; cursor: pointer; }
    .radio-option input { margin-right: 10px; accent-color: var(--accent); }

  </style>
</head>
<body>

  <div id="app-container">
    <div id="title-bar">
      <div class="window-controls">
        <div class="control-btn btn-close" id="winClose" title="Minimize to Tray"></div>
        <div class="control-btn btn-min" id="winMin"></div>
      </div>
      <div class="title-text">FE2CM Audio Player</div>
    </div>

    <div id="content">
      <div id="login-screen">
        <h2>Welcome</h2>
        <input type="text" id="username" placeholder="Roblox Username">
        <button class="connect-btn" id="connectBtn">Connect</button>
      </div>

      <div id="dashboard">
        <div class="status-bar">
          Connected as <span id="displayUser" class="status-user">Guest</span>
        </div>

        <div class="control-group">
          <div class="label-row"><span>Volume</span><span id="volDisplay">70%</span></div>
          <input type="range" id="volume" min="0" max="100" value="70">
        </div>

        <div class="control-group">
          <div class="label-row">On Death</div>
          <div class="radio-group">
            <label class="radio-option"><input type="radio" name="onDeath" value="Quieten BGM"> Quieten BGM</label>
            <label class="radio-option"><input type="radio" name="onDeath" value="Stop BGM"> Stop BGM</label>
            <label class="radio-option"><input type="radio" name="onDeath" value="Disable"> Disable</label>
          </div>
        </div>

        <div class="control-group">
          <div class="label-row">Leaving Game</div>
          <div class="radio-group">
            <label class="radio-option"><input type="radio" name="onLeave" value="Stop BGM"> Stop BGM</label>
            <label class="radio-option"><input type="radio" name="onLeave" value="Disable"> Disable</label>
          </div>
        </div>

        <button class="disconnect-btn" id="disconnectBtn">Disconnect</button>
      </div>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');

    // --- WINDOW CONTROLS ---
    document.getElementById('winClose').onclick = () => ipcRenderer.send('app-close');
    document.getElementById('winMin').onclick = () => ipcRenderer.send('app-minimize');

    // --- CONNECT ---
    document.getElementById('connectBtn').onclick = () => {
      const user = document.getElementById('username').value;
      if(!user) return;
      ipcRenderer.send('connect-user', user);
      switchToDashboard(user);
    };

    function switchToDashboard(user) {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      document.getElementById('displayUser').innerText = user;
    }

    // --- DISCONNECT ---
    document.getElementById('disconnectBtn').onclick = () => {
      ipcRenderer.send('disconnect-game');
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('login-screen').style.display = 'flex';
    };

    // --- CONTROLS ---
    const volSlider = document.getElementById('volume');
    volSlider.oninput = () => {
      document.getElementById('volDisplay').innerText = volSlider.value + '%';
      ipcRenderer.send('set-volume', volSlider.value);
    };

    document.querySelectorAll('input[type="radio"]').forEach(radio => {
      radio.onchange = (e) => {
        ipcRenderer.send('click-option', e.target.name, e.target.value); 
      };
    });

    // --- LISTENERS (For Auto-Load & Tray Changes) ---
    
    // Called when the app starts with saved data
    ipcRenderer.on('restore-state', (event, data) => {
        if(data.username) {
            document.getElementById('username').value = data.username;
            switchToDashboard(data.username);
        }
        if(data.volume) {
            volSlider.value = data.volume;
            document.getElementById('volDisplay').innerText = data.volume + '%';
        }
        if(data.onDeath) {
            const el = document.querySelector(`input[name="onDeath"][value="${data.onDeath}"]`);
            if(el) el.checked = true;
        }
        if(data.onLeave) {
            const el = document.querySelector(`input[name="onLeave"][value="${data.onLeave}"]`);
            if(el) el.checked = true;
        }
    });

    // Called when user changes Volume via Tray
    ipcRenderer.on('update-volume', (event, val) => {
        volSlider.value = val;
        document.getElementById('volDisplay').innerText = val + '%';
    });

  </script>
</body>
</html>