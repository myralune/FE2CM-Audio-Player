<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>FE2CM Audio Player</title>
  <style>
    :root {
      --bg-color: #1a202c;
      --card-bg: #2d3748;
      --accent: #3182ce;
      --danger: #e53e3e;
      --text-main: #edf2f7;
      --text-muted: #a0aec0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: transparent;
      user-select: none;
      height: 100vh;
      overflow: hidden;
    }

    ::-webkit-scrollbar {
      display: none;
    }

    #app-container {
      background-color: var(--bg-color);
      color: var(--text-main);
      height: 87.5%;
      border-radius: 10px;
      border: 1px solid #4a5568;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      position: relative;
      overflow: hidden;
    }

    /* TITLE BAR */
    #title-bar {
      height: 32px;
      background: #2d3748;
      display: flex;
      align-items: center;
      padding: 0 10px;
      border-radius: 10px 10px 0 0;
      -webkit-app-region: drag;
    }

    .title-text {
      font-size: 12px;
      color: var(--text-muted);
      flex-grow: 1;
      text-align: center;
      margin-right: 20px;
    }

    .window-controls {
      display: flex;
      gap: 8px;
      -webkit-app-region: no-drag;
    }

    .control-btn {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      cursor: pointer;
    }

    .btn-close {
      background-color: #ff5f56;
    }

    .btn-close:hover {
      background-color: #bf403a;
    }

    .btn-min {
      background-color: #ffbd2e;
    }

    .btn-min:hover {
      background-color: #c99624;
    }

    /* SETTINGS BUTTON */
    .settings-btn {
      color: var(--text-muted);
      cursor: pointer;
      font-size: 16px;
      margin-left: 10px;
      -webkit-app-region: no-drag;
      transition: color 0.2s;
    }

    .settings-btn:hover {
      color: white;
    }

    /* CONTENT */
    #content {
      padding: 20px;
      flex-grow: 1;
      position: relative;
      overflow-y: auto;
    }

    /* FULL SCREEN SETTINGS MODAL */
    #settings-modal {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg-color);
      z-index: 200;
      padding: 20px;
      flex-direction: column;
      overflow-y: auto;
      animation: fadeIn 0.15s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #4a5568;
      -webkit-app-region: drag;
    }

    .settings-header h3 {
      margin: 0;
      font-size: 18px;
      color: var(--text-main);
    }

    .close-settings-btn {
      font-size: 24px;
      color: var(--text-muted);
      cursor: pointer;
      -webkit-app-region: no-drag;
      line-height: 1;
    }

    .close-settings-btn:hover {
      color: white;
    }

    .settings-section {
      margin-bottom: 15px;
    }

    .settings-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: bold;
    }

    .setting-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      height: 32px;
    }

    .setting-row span {
      line-height: 1;
      display: flex;
      align-items: center;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 20px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #4a5568;
      transition: .4s;
      border-radius: 20px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked+.slider {
      background-color: var(--accent);
    }

    input:checked+.slider:before {
      transform: translateX(20px);
    }

    input.hotkey-input {
      background: var(--card-bg);
      border: 1px solid #4a5568;
      color: var(--text-main);
      padding: 0 8px;
      border-radius: 4px;

      width: 130px !important;
      min-width: 130px !important;
      max-width: 130px !important;
      flex-shrink: 0;

      height: 32px;
      line-height: 32px;
      text-align: center;
      font-family: monospace;
      cursor: pointer;
      caret-color: transparent;
      box-sizing: border-box;
      margin: 0 !important;
    }

    input.hotkey-input:focus {
      border-color: var(--accent);
      background: #2c3e50;
    }

    input.hotkey-input::placeholder {
      color: var(--text-muted);
      font-style: italic;
    }

    /* NEW: CUSTOM FILE UPLOAD STYLING */
    .file-upload-container {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      margin-top: 5px;
    }

    input[type="file"] {
      display: none;
      /* Hide the ugly default input */
    }

    .file-upload-btn {
      background: var(--card-bg);
      border: 1px solid #4a5568;
      color: var(--text-main);
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .file-upload-btn:hover {
      background: #3a4a5e;
      border-color: var(--accent);
    }

    .file-name-display {
      font-size: 12px;
      color: var(--text-muted);
      font-style: italic;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 180px;
    }

    /* GENERAL UI */
    button {
      border: none;
      padding: 12px;
      border-radius: 6px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
      transition: all 0.2s;
    }

    .connect-btn {
      background: var(--accent);
      color: white;
    }

    .connect-btn:hover {
      background: #4299e1;
    }

    .disconnect-btn {
      background: var(--danger);
      color: white;
      margin-top: 20px;
    }

    .disconnect-btn:hover {
      background: #f56565;
    }

    input[type="text"] {
      background: var(--card-bg);
      border: 1px solid #4a5568;
      color: white;
      padding: 12px;
      border-radius: 6px;
      font-size: 16px;
      outline: none;
      text-align: center;
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 15px;
    }

    input[type="text"]:focus {
      border-color: var(--accent);
    }

    /* LOADING SPINNER */
    #loading-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
    }

    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-left-color: var(--accent);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    #login-screen {
      display: none;
      flex-direction: column;
      gap: 15px;
      margin-top: 50px;
      text-align: center;
    }

    #dashboard {
      display: none;
      background: var(--card-bg);
      padding: 20px;
      border-radius: 8px;
    }

    .status-bar {
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #4a5568;
      text-align: center;
      font-size: 14px;
      color: var(--text-muted);
    }

    .status-user {
      color: var(--accent);
      font-weight: bold;
      font-size: 15px;
    }

    .control-group {
      margin-bottom: 20px;
    }

    .label-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 14px;
      color: var(--text-main);
    }

    input[type=range] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      background: transparent;
      border-radius: 4px;
    }

    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      height: 16px;
      width: 16px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      margin-top: -6px;
      box-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
    }

    input[type=range]::-webkit-slider-runnable-track {
      width: 100%;
      height: 4px;
      border-radius: 2px;
    }

    .radio-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 14px;
    }

    .radio-option {
      display: flex;
      align-items: center;
      cursor: pointer;
      color: var(--text-main);
    }

    .radio-option input {
      margin-right: 10px;
      accent-color: var(--accent);
    }
  </style>
</head>

<body>
  <div id="app-container">
    <div id="title-bar">
      <div class="window-controls">
        <div class="control-btn btn-close" id="winClose"></div>
        <div class="control-btn btn-min" id="winMin"></div>
      </div>
      <div class="title-text">FE2CM Audio Player</div>
      <div class="settings-btn" id="openSettings">⚙️</div>
    </div>

    <div id="content">

      <div id="settings-modal">
        <div class="settings-header">
          <h3>Settings</h3>
          <div class="close-settings-btn" id="closeSettings">×</div>
        </div>

        <div class="settings-section">
          <div class="settings-label">App Behavior</div>
          <div class="setting-row">
            <span>Connect on Launch</span>
            <label class="switch"><input type="checkbox" id="set-autoConnect"><span class="slider"></span></label>
          </div>
          <div class="setting-row">
            <span>Start Minimized (Silent)</span>
            <label class="switch"><input type="checkbox" id="set-startMinimized"><span class="slider"></span></label>
          </div>
          <div class="setting-row">
            <span>Minimize to Tray on Exit</span>
            <label class="switch"><input type="checkbox" id="set-minimizeOnClose"><span class="slider"></span></label>
          </div>
        </div>

        <div class="settings-section">
          <div class="settings-label">Custom Audio Override</div>
          <div class="setting-row">
            <span>Enable Custom Audio</span>
            <label class="switch"><input type="checkbox" id="set-customAudioEnabled"><span
                class="slider"></span></label>
          </div>
          <div class="file-upload-container">
            <label for="customAudioFile" class="file-upload-btn">Choose Audio File</label>
            <span id="fileNameDisplay" class="file-name-display">No file selected</span>
            <input type="file" id="customAudioFile" accept="audio/*">
          </div>
        </div>

        <div class="settings-section">
          <div class="settings-label">Global Hotkeys</div>
          <div class="setting-row">
            <span>Toggle Mute</span>
            <input type="text" class="hotkey-input" id="key-mute" placeholder="None" readonly>
          </div>
          <div class="setting-row">
            <span>Volume Up</span>
            <input type="text" class="hotkey-input" id="key-volUp" placeholder="None" readonly>
          </div>
          <div class="setting-row">
            <span>Volume Down</span>
            <input type="text" class="hotkey-input" id="key-volDown" placeholder="None" readonly>
          </div>
        </div>
      </div>

      <div id="loading-screen">
        <div class="spinner"></div>
        <div id="loadingText" style="color: var(--text-muted);">Loading...</div>
      </div>

      <div id="login-screen">
        <h2>Welcome</h2>
        <input type="text" id="username" placeholder="Roblox Username">
        <button class="connect-btn" id="connectBtn">Connect</button>
      </div>

      <div id="dashboard">
        <div class="status-bar">
          Connected as <span id="displayUser" class="status-user">Guest</span>
        </div>

        <div class="control-group">
          <div class="label-row"><span>Volume</span><span id="volDisplay">70%</span></div>
          <input type="range" id="volume" min="0" max="100" value="70">
        </div>

        <div class="control-group">
          <div class="label-row">On Death</div>
          <div class="radio-group">
            <label class="radio-option"><input type="radio" name="onDeath" value="Quieten BGM"> Quieten BGM</label>
            <label class="radio-option"><input type="radio" name="onDeath" value="Stop BGM"> Stop BGM</label>
            <label class="radio-option"><input type="radio" name="onDeath" value="Disable"> Disable</label>
          </div>
        </div>

        <div class="control-group">
          <div class="label-row">Leaving Game</div>
          <div class="radio-group">
            <label class="radio-option"><input type="radio" name="onLeave" value="Stop BGM"> Stop BGM</label>
            <label class="radio-option"><input type="radio" name="onLeave" value="Disable"> Disable</label>
          </div>
        </div>
        <button class="disconnect-btn" id="disconnectBtn">Disconnect</button>
      </div>
    </div>
  </div>

  <script>
    const api = window.electronAPI;

    const settingsModal = document.getElementById('settings-modal');
    document.getElementById('openSettings').onclick = () => settingsModal.style.display = 'flex';
    document.getElementById('closeSettings').onclick = () => settingsModal.style.display = 'none';

    function triggerSave() {
      const settings = {
        autoConnect: document.getElementById('set-autoConnect').checked,
        startMinimized: document.getElementById('set-startMinimized').checked,
        minimizeOnClose: document.getElementById('set-minimizeOnClose').checked,
        hotkeys: {
          mute: document.getElementById('key-mute').value,
          volUp: document.getElementById('key-volUp').value,
          volDown: document.getElementById('key-volDown').value
        }
      };
      api.saveAdvancedSettings(settings);
    }

    function updateVolumeFill() {
      const slider = document.getElementById('volume');
      const val = slider.value;
      const min = slider.min ? slider.min : 0;
      const max = slider.max ? slider.max : 100;

      const percentage = ((val - min) / (max - min)) * 100;

      slider.style.background = `linear-gradient(to right, #3182ce ${percentage}%, #4a5568 ${percentage}%)`;
    }

    document.getElementById('set-autoConnect').onchange = triggerSave;
    document.getElementById('set-startMinimized').onchange = triggerSave;
    document.getElementById('set-minimizeOnClose').onchange = triggerSave;

    let customAudioPlayer = new Audio();
    customAudioPlayer.loop = true;
    let isCustomAudioEnabled = false;

    document.getElementById('customAudioFile').onchange = (e) => {
      const file = e.target.files[0];
      const fileNameDisplay = document.getElementById('fileNameDisplay');
      if (file) {
        customAudioPlayer.src = URL.createObjectURL(file);
        fileNameDisplay.innerText = file.name;
      } else {
        fileNameDisplay.innerText = "No file selected";
      }
    };

    document.getElementById('set-customAudioEnabled').onchange = (e) => {
      isCustomAudioEnabled = e.target.checked;
      if (!isCustomAudioEnabled) {
        customAudioPlayer.pause();
        api.setSiteMute(false);
      } else {
        if (customAudioPlayer.src && !customAudioPlayer.paused) {
          api.setSiteMute(true);
        }
      }
    };

    api.onGameAudioState((state) => {
      if (!isCustomAudioEnabled || !customAudioPlayer.src) {
        api.setSiteMute(false);
        return;
      }

      if (state === 'playing') {
        api.setSiteMute(true);
        if (customAudioPlayer.paused) {
          customAudioPlayer.play().catch(e => console.log("Play error", e));
        }
      } else {
        if (!customAudioPlayer.paused) {
          customAudioPlayer.pause();
          customAudioPlayer.currentTime = 0;
        }
      }
    });

    api.onConnectionStatus((status) => {
      if (status === 'show-login') {
        showScreen('login-screen');
      } else if (status === 'connected') {
        showScreen('dashboard');
      }
    });

    api.onStartLoading(() => {
      document.getElementById('loadingText').innerText = "Connecting...";
      showScreen('loading-screen');
    });

    function setupHotkeyInput(id) {
      const input = document.getElementById(id);
      input.onkeydown = (e) => {
        e.preventDefault();
        if (['Control', 'Alt', 'Shift', 'Meta'].includes(e.key)) return;

        let keys = [];
        if (e.ctrlKey) keys.push('Ctrl');
        if (e.altKey) keys.push('Alt');
        if (e.shiftKey) keys.push('Shift');

        let char = e.key.toUpperCase();
        if (e.code === 'Space') char = 'Space';

        keys.push(char);
        input.value = keys.join('+');
        triggerSave();
      };
      input.onkeyup = (e) => {
        if (e.key === 'Backspace' || e.key === 'Delete') {
          input.value = '';
          triggerSave();
        }
      }
    }
    setupHotkeyInput('key-mute');
    setupHotkeyInput('key-volUp');
    setupHotkeyInput('key-volDown');

    function showScreen(screenId) {
      ['loading-screen', 'login-screen', 'dashboard'].forEach(id => {
        document.getElementById(id).style.display = (id === screenId) ? (id === 'loading-screen' ? 'flex' : 'block') : 'none';
      });
    }

    document.getElementById('winClose').onclick = () => api.close();
    document.getElementById('winMin').onclick = () => api.minimize();

    document.getElementById('connectBtn').onclick = () => {
      const user = document.getElementById('username').value;
      if (!user) return;

      document.getElementById('displayUser').innerText = user;

      showScreen('loading-screen');
      setTimeout(() => {
        api.connectUser(user);
      }, 500);
    };

    document.getElementById('disconnectBtn').onclick = () => {
      api.disconnectGame();
      showScreen('login-screen');
    };

    const volSlider = document.getElementById('volume');
    volSlider.oninput = () => {
      const val = volSlider.value;
      document.getElementById('volDisplay').innerText = val + '%';
      api.setVolume(val);
      customAudioPlayer.volume = val / 100;

      updateVolumeFill();
    };

    document.querySelectorAll('input[type="radio"]').forEach(radio => {
      radio.onchange = (e) => api.clickOption(e.target.name, e.target.value);
    });

    api.onStartLoading(() => showScreen('loading-screen'));

    api.onConnectionStatus((status) => {
      if (status === 'connected') {
        showScreen('dashboard');
      }
    });

    api.onRestoreState((data) => {
      if (data.username) {
        document.getElementById('username').value = data.username;
        document.getElementById('displayUser').innerText = data.username;
      }
      if (data.volume) {
        volSlider.value = data.volume;
        document.getElementById('volDisplay').innerText = data.volume + '%';
        customAudioPlayer.volume = data.volume / 100;

        updateVolumeFill();
      }
      if (data.onDeath) {
        const el = document.querySelector(`input[name="onDeath"][value="${data.onDeath}"]`);
        if (el) el.checked = true;
      }
      if (data.onLeave) {
        const el = document.querySelector(`input[name="onLeave"][value="${data.onLeave}"]`);
        if (el) el.checked = true;
      }

      if (data.settings) {
        document.getElementById('set-autoConnect').checked = data.settings.autoConnect;
        document.getElementById('set-startMinimized').checked = data.settings.startMinimized;
        document.getElementById('set-minimizeOnClose').checked = data.settings.minimizeOnClose;

        if (data.settings.hotkeys) {
          document.getElementById('key-mute').value = data.settings.hotkeys.mute || '';
          document.getElementById('key-volUp').value = data.settings.hotkeys.volUp || '';
          document.getElementById('key-volDown').value = data.settings.hotkeys.volDown || '';
        }
      }
    });

    api.onUpdateVolume((val) => {
      volSlider.value = val;
      document.getElementById('volDisplay').innerText = val + '%';
      customAudioPlayer.volume = val / 100;

      updateVolumeFill();
    });

    updateVolumeFill();
  </script>
</body>

</html>